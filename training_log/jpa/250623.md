# ğŸ—“ï¸ 2025.06.23 (ì›”) â€“ êµìœ¡ ì¼ì§€

## ğŸ“š ì˜¤ëŠ˜ ë°°ìš´ ë‚´ìš©
### JPA
#### JPQL
- Group Function
  - JPQLì˜ ê·¸ë£¹í•¨ìˆ˜ëŠ” COUNT, MAX, MIN, SUM, AVGë¡œ SQLì˜ ê·¸ë£¹í•¨ìˆ˜ì™€ ì°¨ì´ê°€ ì—†ë‹¤.
  - ì£¼ì˜ì‚¬í•­
    - 1. ê·¸ë£¹í•¨ìˆ˜ì˜ ë°˜í™˜ íƒ€ì…ì€ ê²°ê³¼ ê°’ì´ ì •ìˆ˜ë©´ Long, ì‹¤ìˆ˜ë©´ Doubleë¡œ ë°˜í™˜ëœë‹¤.
    - 2. ê°’ì´ ì—†ëŠ” ìƒíƒœì—ì„œ countë¥¼ ì œì™¸í•œ ê·¸ë£¹ í•¨ìˆ˜ëŠ” nullì´ë˜ê³  countë§Œ 0ì´ ëœë‹¤. ë”°ë¼ì„œ ë°˜í™˜ê°’ì„ ë‹´ê¸° ìœ„í•´ ì„ ì–¸í•˜ëŠ” ë³€ìˆ˜ íƒ€ì…ì„ ê¸°ë³¸ìë£Œí˜•ìœ¼ë¡œ í•˜ê²Œ ë˜ë©´, ì¡°íšŒ ê²°ê³¼ë¥¼ ì–¸ë°•ì‹±í•  ë–„ NPEê°€ ë°œìƒí•œë‹¤.
    - 3. ê·¸ë£¹ í•¨ìˆ˜ì˜ ë°˜í™˜ ìë£Œí˜•ì€ Long ë˜ëŠ” Double í˜•ì´ê¸° ë•Œë¬¸ì— Having ì ˆì—ì„œ ê·¸ë£¹ í•¨ìˆ˜ ê²°ê³¼ê°’ê³¼ ë¹„êµí•˜ê¸° ìœ„í•œ íŒŒë¼ë¯¸í„° íƒ€ì…ì€ Long or Doubleë¡œ í•´ì•¼í•œë‹¤.
  - ì˜ˆì‹œ
    - COUNTê°€ ì•„ë‹Œ ê·¸ë£¹í•¨ìˆ˜ëŠ” Wrapper Classë¡œ ë°˜í™˜ ë°›ì•„ì•¼ í•œë‹¤.
      ```
      public Long otherWithNoReuslt(int categoryCode) {
        String jpql = "SELECT SUM(m.menuPrice) FROM Section05Menu m WHERE m.categoryCode = :categoryCode";

        Long sumOfMenu = entityManager.createQuery(jpql, Long.class)
                .setParameter("categoryCode", categoryCode)
                .getSingleResult();

        return sumOfMenu;
      }
      ``` 
- Join
  - ì¼ë°˜ì ì¸ SQL ì¡°ì¸ì„ ì˜ë¯¸í•œë‹¤. (Inner Join, Outer Join ë“±ë“±)
  - Inner Join
    ```
    /* ë¬¸ì œì  */
    
    public List<Menu> selectByInnerJoin() {
        String jpql = "SELECT m FROM Section06Menu m JOIN m.category c";

        List<Menu> menuList = entityManager.createQuery(jpql, Menu.class).getResultList();

        return menuList;
    }
    ```
    - ì´ë¯¸ ì—”í‹°í‹°ì—ì„œ Join ê´€ê³„ë¥¼ í‘œí˜„í•´ì£¼ê³  ìˆê¸° ë•Œë¬¸ì— ONì„ ì‘ì„±í•´ì¤„ í•„ìš”ëŠ” ì—†ë‹¤.
    - ì´ ì½”ë“œì—ì„œëŠ” Menu ì—”í‹°í‹°ëŠ” í•œë²ˆì˜ ì¿¼ë¦¬ë¡œ ë‹¤ ë¶ˆëŸ¬ì˜¤ì§€ë§Œ ê·¸ ì•ˆì— ìˆëŠ” category í•„ë“œëŠ” ì§€ì—°ë¡œë”© ë¨.
    - ë”°ë¼ì„œ ê° ë©”ë‰´ë§ˆë‹¤ ê°œë³„ì ìœ¼ë¡œ SELECT ë¬¸ì„ ì‹¤í–‰í•˜ê²Œ ë˜ê³  ëª¨ë“  ì¹´í…Œê³ ë¦¬ë¥¼ ë‹¤ ë¶ˆëŸ¬ì˜¬ ë•Œê¹Œì§€ ë°˜ë³µë¨.
    - ì´ N+1ë²ˆì˜ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ê²Œ ë˜ëŠ” N+1ë¬¸ì œê°€ ë°œìƒí•˜ê²Œ ëœë‹¤.
    ```
    /* í•´ê²° ë°©ë²• */
    
    public List<Menu> selectByFetchJoin() {
        String jpql = "SELECT m FROM Section06Menu m JOIN FETCH m.category c";

        List<Menu> menuList = entityManager.createQuery(jpql, Menu.class).getResultList();

        return menuList;
    }
    ```
    - JOIN FETCHë¥¼ ì‚¬ìš©í•˜ë©´ JPAê°€ Menuì™€ Categoryë¥¼ í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ëª¨ë‘ ê°€ì ¸ì˜´ (ì¦‰ì‹œ ë¡œë”©)
    - ê²°ê³¼ì ìœ¼ë¡œ N+1 ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.
  - Outer Join
    ```
    public List<Object[]> selectByOuterJoin() {
        String jpql = "SELECT m.menuName, c.categoryName FROM Section06Menu m " +
                "RIGHT JOIN m.category c " +
                "ORDER BY m.category.categoryCode";

        List<Object[]> menuList = entityManager.createQuery(jpql).getResultList();

        return menuList;
    }
    ```
    - JPQLì„ í†µí•´ Right Join, Left Join ë“± Outer Joinë„ ê°€ëŠ¥í•˜ë‹¤
  - Collection Join
    ```
    public List<Object[]> selectByCollectionJoin() {
        String jpql = "SELECT m.menuName, c.categoryName FROM Section06Category c " +
                "RIGHT JOIN c.menuList m " +
                "ORDER BY m.category.categoryCode";

        List<Object[]> categoryList = entityManager.createQuery(jpql).getResultList();

        return categoryList;
    }
    ```
    - JPAì—ì„œ ì—”í‹°í‹° ì•ˆì— í¬í•¨ëœ ì»¬ë ‰ì…˜(List, Set ë“±)ì„ ì¡°ì¸í•˜ëŠ” ê²ƒ

#### native query
- native query
  - ë°ì´í„°ë² ì´ìŠ¤ì— ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ì›ì‹œ SQL ë¬¸ì„ JPAì—ì„œ ì‹¤í–‰í•˜ëŠ” ë°©ì‹
  - ì—”í‹°í‹°ì˜ í•„ë“œëª…ì„ ì ëŠ” JPQLê³¼ëŠ” ë‹¤ë¥´ê²Œ native queryëŠ” ë°ì´í„°ë² ì´ìŠ¤ì˜ ì»¬ëŸ¼ëª…ì„ ì‘ì„±í•œë‹¤.
  - ì¥ì  : ë³µì¡í•œ ì¿¼ë¦¬ë‚˜ DBì˜ ê³ ìœ  ê¸°ëŠ¥ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ
  - ë‹¨ì  : JPQLì´ ì•„ë‹ˆì–´ì„œ ì—”í‹°í‹° ë§¤í•‘ì„ ì§ì ‘ ì§€ì •í•´ ì£¼ì–´ì•¼ í•¨.
  - ì˜ˆì‹œ
    - ëª¨ë“  ì»¬ëŸ¼ ì¡°íšŒ
      ```
      public Menu nativeQueryByResultType(int menuCode) {
        
          String query = "SELECT menu_code, menu_name, menu_price, category_code, orderable_status " +
                  "FROM tbl_menu " +
                  "WHERE menu_code = ?";

          Query nativeQuery = entityManager.createNativeQuery(query, Menu.class)
                  .setParameter(1, menuCode);

          // ê¸°ë³¸ ì œê³µ íƒ€ì…ì€ Objectì´ê¸° ë•Œë¬¸ì— ì—”í‹°í‹°ë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ ë‹¤ìš´ ìºìŠ¤íŒ…ì„ í•´ì¤˜ì•¼ í•œë‹¤.
          return (Menu) nativeQuery.getSingleResult();
      }
      ```
      - Native Query ìˆ˜í–‰ ê²°ê³¼ë¥¼ ì—”í‹°í‹°ì— ë§¤í•‘ ì‹œí‚¤ë ¤ë©´ ëª¨ë“  ì»¬ëŸ¼ì´ ì¡°íšŒ ë˜ì–´ì•¼ë§Œ ë§¤í•‘ ê°€ëŠ¥í•˜ë‹¤.
    - DBì— ì—†ëŠ” ì»¬ëŸ¼ëª… ì¡°íšŒí•˜ê¸°
      ```
      // Repository í´ë˜ìŠ¤
      
      public List<Object[]> nativeQueryByAutoMapping() {
        
        String query
                = "SELECT a.category_code, a.category_name, a.ref_category_code," +
                " COALESCE(v.menu_count, 0) menu_count" +
                " FROM tbl_category a" +
                " LEFT JOIN (SELECT COUNT(*) AS menu_count, b.category_code" +
                " FROM tbl_menu b" +
                " GROUP BY b.category_code) v ON (a.category_code = v.category_code)" +
                " ORDER BY 1";
        Query nativeQuery
                = entityManager.createNativeQuery(query, "categoryCountAutoMapping");
        return nativeQuery.getResultList();
      }
      ```
      - menu_countëŠ” ë‚´ê°€ ë§Œë“¤ì–´ì¤€ ê°’ì´ê¸° ë•Œë¬¸ì— ë§¤í•‘ ë¶ˆê°€ëŠ¥
      - ë”°ë¼ì„œ Category ì—”í‹°í‹°ì— @SqlResultSetMappings ì–´ë…¸í…Œì´ì…˜ì˜ valueê°’ì„ ì„¤ì •í•´ì¤€ë‹¤.
      ```
      // Category ì—”í‹°í‹°
      
      @SqlResultSetMappings(
        value = {
                /* ìë™ ì—”í‹°í‹° ë§¤í•‘ */
                @SqlResultSetMapping(
                        name = "categoryCountAutoMapping",
                        entities = {
                                @EntityResult(entityClass = Category.class)
                        },
                        columns = {
                                @ColumnResult(name = "menu_count")
                        }
                )
            }
      )
      ```
      - Category ì—”í‹°í‹°ì— í•´ë‹¹ ì–´ë…¸í…Œì´ì…˜ì„ ì„¤ì •í•˜ë©´ ë„¤ì´í‹°ë¸Œ SQLì„ ì‹¤í–‰í–ˆì„ ë•Œ ë°˜í™˜ëœ ê²°ê³¼ í–‰(row)ì„ JPAê°€ ì–´ë–»ê²Œ ë§¤í•‘(mapping)í• ì§€ ì•Œë ¤ì¤€ë‹¤.
      - `entities` ì˜µì…˜ì„ í†µí•´ ê²°ê³¼ë¡œ ëŒì•„ì˜¤ëŠ” ì»¬ëŸ¼ë“¤ ì¤‘ì—ì„œ Category ì—”í‹°í‹°ì˜ í•„ë“œì™€ ì´ë¦„ì´ ì¼ì¹˜í•˜ëŠ” ì»¬ëŸ¼ë“¤ì„ ìë™ìœ¼ë¡œ ë§¤í•‘í•¨.
      - `columns` ì˜µì…˜ì„ í†µí•´ ì—”í‹°í‹° ë§¤í•‘ê³¼ ë³„ê°œë¡œ, ê²°ê³¼ì…‹ì— í¬í•¨ëœ ìŠ¤ì¹¼ë¼ ì»¬ëŸ¼(ì—¬ê¸°ì„œëŠ” menu_count) ì¶”ê°€ê°’ì„ ë§¤í•‘
      - ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ ì‹¤í–‰ ê²°ê³¼ë¥¼ Object[] ë°°ì—´ë¡œ ë°›ëŠ”ë‹¤ë©´ [0]ì—ëŠ” Category ì—”í‹°í‹° ê°ì²´, [1]ì—ëŠ” menu_countì˜ ì •ìˆ˜ê°’ì´ ë“¤ì–´ê°€ê²Œ ëœë‹¤.
- named query
  - ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œì ì— ì˜êµ¬ì ìœ¼ë¡œ ì •ì˜í•´ë‘ê³ , ì´ë¦„ìœ¼ë¡œ ì¬ì‚¬ìš©í•˜ëŠ” JPQL ë˜ëŠ” Native SQL
  - ì¥ì  : ì¿¼ë¦¬ë¥¼ í•œ ê³³ì— ëª¨ì•„ë‘ì–´ ê´€ë¦¬í•˜ê¸° ì‰¬ì›€, ë¬¸ë²• ì˜¤ë¥˜ë¥¼ ë¹¨ë¦¬ ë°œê²¬í•˜ê²Œ ë¨.
  - ë‹¨ì  : ì½”ë“œì™€ ë¶„ë¦¬ë˜ì–´ ê´€ë¦¬ë˜ëŠ” ê²½ìš°, IDE ë¦¬íŒ©í† ë§ ì‹œ ìë™ ì¶”ì²™ì´ ì–´ë ¤ì›€
  - ì—”í‹°í‹° í´ë˜ìŠ¤ì— ì •ì˜ í•œë‹¤.
  - ì˜ˆì‹œ
    ```
    // Repository í´ë˜ìŠ¤
    
    @Repository
    public class NamedQueryRepository {
    
        @PersistenceContext
        private EntityManager entityManager;
    
        public List<Object[]> selectByNamedNativeQuery() {
            Query nativeQuery
                    = entityManager.createNamedQuery("Category.menuCountOfCategory");
    
            return nativeQuery.getResultList();
        }
    }
    ```
    - ì—”í‹°í‹° í´ë˜ìŠ¤ì—ì„œ ì •ì˜í•œ ë„¤ì„ë“œ ì¿¼ë¦¬ í˜¸ì¶œ
    ```
    @SqlResultSetMapping(
        name = "categoryCountAutoMapping2",
        entities = {@EntityResult(entityClass = Category.class)},
        columns = {@ColumnResult(name = "menu_count")}
    )
    @NamedNativeQueries(
      value = {
         @NamedNativeQuery(
           name = "Category.menuCountOfCategory",
           query = "SELECT a.category_code, a.category_name, a.ref_category_code," +
           " COALESCE(v.menu_count, 0) menu_count" +
           " FROM tbl_category a" +
           " LEFT JOIN (SELECT COUNT(*) AS menu_count, b.category_code" +
           " FROM tbl_menu b" +
           " GROUP BY b.category_code) v ON (a.category_code = v.category_code)" +
           " ORDER BY 1",
           resultSetMapping = "categoryCountAutoMapping2"
         )
      }
    )
    ```
    - `name` : ë§¤í•‘ ì •ì˜ë¥¼ ì°¸ì¡°í•  ì‹ë³„ì
    - `entities` : ë„¤ì´íŠ¸ ì¿¼ë¦¬ ê²°ê³¼ì˜ ì²« ë¶€ë¶„ì„ Category ì—”í‹°í‹°ë¡œ ìë™ ë§¤í•‘, ì¿¼ë¦¬ê°€ ë°˜í™˜í•˜ëŠ” ì»¬ëŸ¼ë“¤ ì¤‘ Category í•„ë“œì™€ ì´ë¦„ì´ ì¼ì¹˜í•˜ëŠ” ê²ƒë“¤ì„ ì±„ì›€
    - `columns` : ì—”í‹°í‹° ë§¤í•‘ ì™¸ì— ì¶”ê°€ë¡œ ë°˜í™˜ë˜ëŠ” ìŠ¤ì¹¼ë¼ ì¹¼ëŸ¼ ê°’ì„ êº¼ë‚´ê² ë‹¤ëŠ” ì˜ë¯¸
    - `query` : ì‹¤ì œ ì‹¤í–‰í•  ë„¤ì´í‹°ë¸Œ SQL
    - `resultSetMapping` : ìœ„ì—ì„œ ì •ì˜í•œ ê²°ê³¼ ë§¤í•‘ì„ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©. ì¦‰, ì¿¼ë¦¬ ê²°ê³¼ë¥¼ Category ì—”í‹°í‹° + menu_count ìŠ¤ì¹¼ë¼ ê°’ìœ¼ë¡œ ë§¤í•‘
    
## ğŸ’» ì‹¤ìŠµ ì˜ˆì‹œ
### JPA
- [native queryì™€ named query](../../JPA/chapter05-native-query)

## âœï¸ ì˜¤ëŠ˜ì˜ íšŒê³ 
- ì˜¤ëŠ˜ì€ JPAì˜ ê·¸ë£¹ í•¨ìˆ˜ì™€ ì¡°ì¸, ê·¸ë¦¬ê³  ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ì™€ ë„¤ì„ë“œ ì¿¼ë¦¬ê¹Œì§€ ë‹¤ì–‘í•œ ì¿¼ë¦¬ ê¸°ë²•ì„ ì •ë¦¬í–ˆë‹¤. 
- ì²˜ìŒì—ëŠ” ê·¸ë£¹ í•¨ìˆ˜ì˜ ë°˜í™˜ íƒ€ì…ê³¼ N+1 ë¬¸ì œ ë•Œë¬¸ì— í—·ê°ˆë ¸ëŠ”ë°, ì˜ˆì‹œ ì½”ë“œë¥¼ ë”°ë¼ ì¨ ë³´ë©´ì„œ ì™œ ë°œìƒí•˜ëŠ”ì§€ ëª…í™•íˆ ì´í•´í•  ìˆ˜ ìˆì—ˆë‹¤. 
- íŠ¹íˆ JOIN FETCHì™€ @SqlResultSetMappingì„ í†µí•´ ë³µì¡í•œ ë„¤ì´í‹°ë¸Œ SQL ê²°ê³¼ë¥¼ ì—”í‹°í‹°ì™€ í•¨ê»˜ ë§¤í•‘í•˜ëŠ” ë°©ë²•ì´ ì‹ ê¸°í–ˆê³  ìœ ìš©í•  ê²ƒ ê°™ë‹¤.