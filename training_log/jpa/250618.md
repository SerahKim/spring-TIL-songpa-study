# ğŸ—“ï¸ 2025.06.18 (ìˆ˜) â€“ êµìœ¡ ì¼ì§€

## ğŸ“š ì˜¤ëŠ˜ ë°°ìš´ ë‚´ìš©
### JPA
#### Persistance Context lifecycle
- Persistence Contextë€?
  - ì—”í‹°í‹°ë¥¼ ì˜êµ¬ ì €ì¥í•˜ëŠ” í™˜ê²½
  - ì—”í‹°í‹° ë§¤ë‹ˆì €ì— ì—”í‹°í‹°ë¥¼ ì €ì¥í•˜ê±°ë‚˜ ì¡°íšŒí•˜ë©´ ì—”í‹°í‹° ë§¤ë‹ˆì €ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ë¥¼ ë³´ê´€í•˜ê³  ê´€ë¦¬í•œë‹¤.
  - ì˜ì†ì„± ì—”í‹°í‹°ë¥¼ key-value ë°©ì‹ìœ¼ë¡œ ì €ì¥í•˜ëŠ” ì €ì¥ì†Œ ì—­í• ì„ í•œë‹¤.
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ ìƒì„±í•  ë•Œë§ˆë‹¤ í•˜ë‚˜ì”© ë§Œë“¤ì–´ì§„ë‹¤.
  - ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ í†µí•´ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ìˆê³  ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤.
- Entity LifeCycle
  - ë¹„ì˜ì† ìƒíƒœ (New/Transient)
    - ì—”í‹°í‹° ê°ì²´ê°€ ìƒì„±ë˜ê³ , ì•„ì§ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì§€ ì•Šì€ ìƒíƒœ 
  - ì˜ì† ìƒíƒœ (Managed)
    - ì—”í‹°í‹° ê°ì²´ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ëœ ìƒíƒœ. 
    - ì´ ìƒíƒœì—ì„œ ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•˜ë©´ ìë™ìœ¼ë¡œ ë°ì´í„° ë² ì´ìŠ¤ì— ë°˜ì˜
  - ì¤€ì˜ì† ìƒíƒœ (Detached)
    - ì—”í‹°í‹° ê°ì²´ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ë¶„ë¦¬ëœ ìƒíƒœ. 
    - ì´ ìƒíƒœì—ì„œëŠ” ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•´ë„ ë°ì´í„°ì—ëŠ” ë°˜ì˜ë˜ì§€ ì•ŠëŠ”ë‹¤.
    - ë¶„ë¦¬ëœ ì—”í‹°í‹°ë¥¼ ë‹¤ì‹œ ê´€ë¦¬ ìƒíƒœë¡œ ë§Œë“¤ì–´ì£¼ê¸° ìœ„í•´ì„œëŠ” `EntityManager` ê°ì²´ì˜ `merge()` ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•œë‹¤.
  - ì‚­ì œ ìƒíƒœ (Removed)
    - ì—”í‹°í‹° ê°ì²´ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì œê±°ëœ ìƒíƒœ. 
    - ì´ ìƒíƒœì—ì„œëŠ” ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•´ë„ ë°ì´í„°ë² ì´ìŠ¤ì—ëŠ” ë°˜ì˜ë˜ì§€ ì•ŠëŠ”ë‹¤.
- Entity LifeCycleì„ ê´€ë¦¬í•˜ëŠ” ë©”ì†Œë“œ
  - `entityManager.detach(foundMenu)` : íŠ¹ì • ì—”í‹°í‹°(ì—¬ê¸°ì„œëŠ” foundMenu)ë§Œ ì¤€ì˜ì† ìƒíƒœ(ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ê´€ë¦¬í•˜ë˜ ê°ì²´ë¥¼ ê´€ë¦¬í•˜ì§€ ì•ŠìŒ)ë¡œ ë§Œë“ ë‹¤.
  - `entityManager.flush()` 
    - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ìƒíƒœë¥¼ DBë¡œ ë‚´ë³´ë‚¸ë‹¤. 
    - commití•˜ì§€ ì•Šì€ ìƒíƒœì´ë¯€ë¡œ `rollback()`ì´ ê°€ëŠ¥í•˜ë‹¤.
    - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë³€ê²½ ë‚´ìš©ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ë™ê¸°í™”í•˜ëŠ” ì‘ì—…ì„ í•œë‹¤.
    - detach í›„ flushë¥¼ í•˜ê²Œ ëœë‹¤ë©´ detachí•œ ê°’ì€ P.Cì— ì—†ëŠ”ì±„ë¡œ DBë¡œ ë‚´ë³´ë‚´ì§€ê²Œ ëœë‹¤.
  - `entityManager.merge(foundMenu)`
    - íŒŒë¼ë¯¸í„°ë¡œ ë„˜ì–´ì˜¨ ì¤€ì˜ì† ì—”í‹°í‹° ê°ì²´(ì—¬ê¸°ì„œëŠ” foundMenu)ì˜ ì‹ë³„ì ê°’ìœ¼ë¡œ 1ì°¨ ìºì‹œì—ì„œ ì—”í‹°í‹° ê°ì²´ë¥¼ ì¡°íšŒí•œë‹¤. (.merge() ì´ì „ì— .detach()ë¥¼ í•´ì¤˜ì„œ ì¤€ì˜ì† ìƒíƒœë¡œ ë§Œë“  ìƒí™©)
    - ì—†ìœ¼ë©´ DBì—ì„œ ì¡°íšŒí•˜ì—¬ 1ì°¨ ìºì‹œì— ì €ì¥í•œë‹¤.
    - ì¦‰, ì¡°íšŒí•œ ì˜ì† ì—”í‹°í‹° ê°ì²´ì— ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹° ê°ì²´ì˜ ê°’ì„ ë³‘í•© í•œ ë’¤ ì˜ì† ì—”í‹°í‹° ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤.
    - ì¡°íšŒí•  ìˆ˜ ì—†ëŠ” ë°ì´í„°ë¼ë©´ ìƒˆë¡œ ìƒì„±í•´ì„œ ë³‘í•©í•œë‹¤.
  - `entityManager.clear()` : ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•œë‹¤. = ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë‚´ ëª¨ë“  ì—”í‹°í‹°ë¥¼ ì¤€ì˜ì†í™” ì‹œí‚¨ë‹¤. (ì»¨í…ìŠ¤íŠ¸ëŠ” ì‚´ì•„ìˆë‹¤.)
  - `entityManager.close()` : ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¢…ë£Œí•œë‹¤. = ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë‚´ ëª¨ë“  ê°ì²´ë¥¼ ì¤€ì˜ì†í™”ì‹œí‚¨ë‹¤. (ì»¨í…ìŠ¤íŠ¸ë„ ë‹«íŒë‹¤.)
  - `entityManager.remove(foundMenu)`
    - í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë° ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚­ì œí•œë‹¤.
    - ë‹¨, íŠ¸ëœì­ì…˜ì„ ì œì–´í•˜ì§€ ì•Šìœ¼ë©´ ë°ì´í„°ë² ì´ìŠ¤ì— ì˜êµ¬ ë°˜ì˜ë˜ì§€ëŠ” ì•ŠëŠ”ë‹¤.
    - íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•˜ëŠ” ìˆœê°„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê´€ë¦¬í•˜ëŠ” ì—”í‹°í‹° ê°ì²´ê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜ëœë‹¤.
    
#### mapping in spring
- í™˜ê²½ì— ë”°ë¥¸ JPA ì„¤ì •
  - | í•­ëª©               | Gradle ì¼ë°˜ Java í”„ë¡œì íŠ¸             | Spring Boot                   |
    | ---------------- | ------------------------------- | ----------------------------- |
    | ì„¤ì • ë°©ì‹            | `persistence.xml` ìˆ˜ë™ ì‘ì„±         | `application.yml` ë˜ëŠ” `.properties` |
    | EntityManager ìƒì„± | ìˆ˜ë™ ìƒì„± (`Persistence.create...`) | ìë™ ì£¼ì… (ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì—ì„œ)            |
    | íŠ¸ëœì­ì…˜ ì²˜ë¦¬          | ìˆ˜ë™ (`EntityTransaction`)        | `@Transactional` ì–´ë…¸í…Œì´ì…˜        |
    | ì˜ì¡´ì„± ê´€ë¦¬           | ì§ì ‘ ì¶”ê°€ (`hibernate-core` ë“±)      | `spring-boot-starter-data-jpa` |
    | Repository ì‚¬ìš©    | ì§ì ‘ êµ¬í˜„                           | `JpaRepository` ì¸í„°í˜ì´ìŠ¤ë§Œ ìƒì†í•˜ë©´ ë |
    | ìƒì‚°ì„± / ìœ ì§€ë³´ìˆ˜ì„±      | ë‚®ìŒ                              | ë†’ìŒ                            |
- JPAì—ì„œ ê¸°ì¡´ì— ì—†ëŠ” í…Œì´ë¸” ìƒì„±í•˜ê¸°
  - `application.yml` íŒŒì¼ ì„¤ì •
    ```
    spring:
    datasource:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/menudb
      username: ohgiraffers
      password: ohgiraffers
    jpa:
      show-sql: true
      database: mysql
      hibernate:
       ddl-auto: create
      properties:
       hibernate:
         format_sql: true
    ```
    - datasource ë° jpaëŒ€í•œ ì •ë³´ë¥¼ ì„¤ì •í•˜ëŠ” íŒŒì¼
    - ddl-auto ì˜µì…˜
      - | ì˜µì…˜ê°’           | ì„¤ëª…                                 |
        | ------------- | ---------------------------------- |
        | `none`        | ìë™ ìƒì„±/ë³€ê²½ ì•ˆ í•¨ (ê¸°ë³¸ê°’)                 |
        | `create`      | ì‹¤í–‰ ì‹œ ê¸°ì¡´ í…Œì´ë¸”ì„ ì‚­ì œí•˜ê³  ìƒˆë¡œ ìƒì„±            |
        | `create-drop` | ì‹¤í–‰ ì‹œ ìƒì„±, ì¢…ë£Œ ì‹œ í…Œì´ë¸” ì‚­ì œ               |
        | `update`      | ì—”í‹°í‹° ê¸°ì¤€ìœ¼ë¡œ í…Œì´ë¸”ì„ ìˆ˜ì • (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)       |
        | `validate`    | ì—”í‹°í‹°ì™€ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆê°€ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì‚¬ë§Œ í•¨ (ë³€ê²½ ì•ˆ í•¨) |
    - ì°¸ê³ 
      - DDL(Data Definition Language)ê³¼ DML(Data Mainpulation Language)
        - | êµ¬ë¶„      | ì—­í•            | ì£¼ìš” ëª…ë ¹ì–´                         | ëŒ€ìƒ              |
          | ------- | ------------ | ------------------------------ | --------------- |
          | **DDL** | ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ê´€ë¦¬ | CREATE, ALTER, DROP, TRUNCATE  | í…Œì´ë¸”, ì¸ë±ìŠ¤, ìŠ¤í‚¤ë§ˆ ë“± |
          | **DML** | ë°ì´í„° ì¡°ì‘       | SELECT, INSERT, UPDATE, DELETE | í…Œì´ë¸” ë‚´ ë°ì´í„°       |
  - EntityManger ìƒì„±
    ```
    @Repository // DBì— ì ‘ê·¼í•˜ëŠ” ì—­í• ì€ í•˜ëŠ” ê°ì²´ ë‹¬ì•„ì£¼ëŠ” ì–´ë…¸í…Œì´ì…˜
    public class MemberRepository {
    
        @PersistenceContext // EntityManageë¥¼ ì‚¬ìš©í•˜ê² ë‹¤ëŠ” ì–´ë…¸í…Œì´ì…˜
        private EntityManager entityManager;
    
        public void save(Member member) {
             entityManager.persist(member);
        }
    }
    ```
    - @PersistenceContext ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ JPAì˜ EntityManagerë¥¼ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ ìë™ ì£¼ì…
    - EntityManagerë¥¼ í†µí•´ DBì— ì ‘ê·¼í•˜ë¯€ë¡œ @Repository ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì„
  - Transaction ì„¤ì •
    ```
    @Service
    public class MemberRegistService {

      private MemberRepository memberRepository;
  
      public MemberRegistService(MemberRepository memberRepository) {
          this.memberRepository = memberRepository;
      }
  
      @Transactional
      // ì „ë‹¬í•´ì£¼ëŠ” ê°’ì€ Entityê°€ ì•„ë‹Œ DTO (ë°ì´í„° ë“±ë¡ì„ ìœ„í•´)
      // DTO -> Entity ê°€ê³µ
      public void registMember(MemberRegistDTO newMember) {
  
          // DTO -> Entity ê°€ê³µ
          Member member = new Member(
                  newMember.getMemberId(),
                  newMember.getMemberPwd(),
                  newMember.getMemberName(),
                  newMember.getPhone(),
                  newMember.getAddress(),
                  newMember.getEnrollDate(),
                  newMember.getMemberRole(),
                  newMember.getStatus()
          );
  
          // Entity ì „ë‹¬
          // .save == .commit : EntityManagerì˜ persist ë™ì‘
          memberRepository.save(member);
      }
    }
    ```
    - Service ê³„ì¸µì—ì„œ @Transaction ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ ìë™ìœ¼ë¡œ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬
    - ë°ì´í„° ë“±ë¡ì„ ìœ„í•´ì„œëŠ” DTOë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ë°›ê³ , ë‚´ë¶€ì—ì„œ DTOë¥¼ Entityë¡œ ë³€í™˜í•´ì„œ JPA(memberRepository.save())ì— ì „ë‹¬í•´ì•¼ í•œë‹¤.

## ğŸ’» ì‹¤ìŠµ ì˜ˆì‹œ
### JPA
- [EntityManager lifecycle & JPA CRUD](../../JPA/chapter01-persistence-context)
- [mapping](../../JPA/chapter02-mapping)

## âœï¸ ì˜¤ëŠ˜ì˜ íšŒê³ 
- EntityManagerì˜ ì£¼ìš” ë©”ì†Œë“œë“¤(detach, merge, flush ë“±)ì„ í†µí•´ ì—”í‹°í‹° ìƒíƒœ ê´€ë¦¬ì— ëŒ€í•´ ì´í•´í–ˆë‹¤. ì•„ì§ë„ í—·ê°ˆë¦¬ëŠ” ë¶€ë¶„ì´ ìˆë‹¤....ì—´ì‹¬íˆ ê³µë¶€í•´ì•¼ í• ë“¯í•˜ë‹¤.
- Spring í™˜ê²½ì—ì„œ JPA ì„¤ì • ë°©ë²•ê³¼ @Repository, @Transactional ì–´ë…¸í…Œì´ì…˜ì˜ ì—­í• ê³¼ ì‚¬ìš© ìœ„ì¹˜ë„ ì•Œê²Œë˜ì—ˆë‹¤. í™•ì‹¤íˆ ë‚´ê°€ ì§ì ‘ ì„¤ì •í•´ì£¼ëŠ” ê²ƒë³´ë‹¤ spring í™˜ê²½ì„ í†µí•´ ê°„ë‹¨í•˜ê²Œ í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ ì°¸ í¸ë¦¬í–ˆë‹¤.
- Spring í”„ë ˆì„ì›Œí¬ì˜ í¸ì˜ì„±ì„ ë‹¤ì‹œ í•œë²ˆ ê¹¨ë‹«ê²Œ ë˜ì—ˆë‹¤.